{% extends 'time_tracking/base.html' %}

{% block title %}Chip scannen{% endblock %}

{% block content %}
<div class="waiting-container">
    <div class="scan-prompt">
        <div class="scan-icon">ðŸ“±</div>
        <h1>Bitte Chip scannen</h1>
        <p>Halten Sie Ihren Chip an den RFID-Leser</p>
        
        <!-- Verstecktes Eingabefeld fÃ¼r USB-Reader -->
        <input type="text" id="chip-input" autofocus autocomplete="off" 
               style="position: absolute; left: -9999px;">
        
        <div class="loading-spinner"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chipInput = document.getElementById('chip-input');
    
    // Fokus immer auf Eingabefeld halten
    function keepFocus() {
        chipInput.focus();
    }
    
    // Fokus alle 100ms wiederherstellen (falls User woanders klickt)
    setInterval(keepFocus, 100);
    keepFocus();
    
    // Bei Enter: Chip-ID an Server senden
    chipInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const chipId = chipInput.value.trim();
            
            if (chipId) {
                console.log('Chip-ID gescannt:', chipId);
                
                // Chip-ID an Server senden
                fetch('{% url "process_chip" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        chip_id: chipId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect_url;
                    } else {
                        alert(data.message || 'Fehler beim Verarbeiten der Chip-ID');
                        chipInput.value = '';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Verbindungsfehler. Bitte erneut versuchen.');
                    chipInput.value = '';
                });
            }
        }
    });
});
</script>

<style>
.waiting-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 80vh;
}

.scan-prompt {
    text-align: center;
}

.scan-icon {
    font-size: 120px;
    margin-bottom: 20px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.loading-spinner {
    margin: 30px auto;
    width: 50px;
    height: 50px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
